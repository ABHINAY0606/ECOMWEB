<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="welcome-text">
      <!-- Dynamic Username Title -->
      <h1>{{ username }}'s Dashboard</h1>
    </div>
    <div class="header-right">
      <!-- Help Button -->
      <button class="help-btn" (click)="showHelp()">Help</button>
      <!-- Removed duplicate Cart count, kept Logout -->
      <button class="logout-btn" (click)="logout()">Logout</button>
    </div>
  </div>

  <div class="tabs">
    <button [class.active]="activeSection === 'products'" (click)="showSection('products')">Available Products</button>
    <button [class.active]="activeSection === 'cart'" (click)="showSection('cart')">Cart ({{ cart.length }})</button>
    <button [class.active]="activeSection === 'orders'" (click)="showSection('orders')">My Orders</button>
  </div>

  <div class="dashboard-content">

    <!-- Welcome Section -->
    <div *ngIf="activeSection === 'welcome'" class="welcome-section">
      <h2>Welcome, {{ username }}! ü•≥‚ú®‚≠ê</h2>
      <p>Select "Available Products" to start shopping.</p>
    </div>

    <!-- Available Products -->
    <div *ngIf="activeSection === 'products'">
      <h3>Available Products</h3>
      <div class="product-grid">
        <div *ngFor="let product of products" class="product-card">
          <img *ngIf="product.imageUrl" [src]="product.imageUrl" class="card-img" alt="{{ product.name }}">
          <div *ngIf="!product.imageUrl" class="card-img-placeholder">No Image</div>
          <h4>{{ product.name }}</h4>
          <p class="price">{{ product.price | currency:'INR' }}</p>
          <p class="desc">{{ product.description }}</p>
          <p class="stock">Stock: {{ product.stock_quantity }}</p>
          <button (click)="addToCart(product)" [disabled]="product.stock_quantity === 0">
            {{ product.stock_quantity > 0 ? 'Add to Cart' : 'Out of Stock' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Cart -->
    <div *ngIf="activeSection === 'cart'">
      <h3>Your Cart</h3>
      <div *ngIf="cart.length === 0">Your cart is empty.</div>
      <table *ngIf="cart.length > 0" class="data-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of cart; let i = index; trackBy: trackByFn">
            <td>{{ item.product.name }}</td>
            <td>{{ item.product.price | currency:'INR' }}</td>
            <td>
              <input type="number" [(ngModel)]="item.quantity" min="1" [max]="item.product.stock_quantity"
                (input)="validateQuantity(item)" (change)="validateQuantity(item)">
              <div *ngIf="item.error" class="error-text" style="color: red; font-size: small;">{{ item.error }}</div>
            </td>
            <td>{{ item.product.price * item.quantity | currency:'INR' }}</td>
            <td><button (click)="removeFromCart(i)" class="delete-btn">Remove</button></td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="cart.length > 0" class="cart-summary">
        <h3>Total: {{ getCartTotal() | currency:'INR' }}</h3>

        <div *ngIf="!isCartValid() && cart.length > 0" class="error-text" style="color: red; margin-bottom: 10px;">
          Please fix invalid quantities before placing order.
        </div>

        <button (click)="placeOrder()" [disabled]="!isCartValid()" class="place-order-btn">
          Place Order
        </button>
      </div>
    </div>

    <!-- My Orders -->
    <div *ngIf="activeSection === 'orders'">
      <h3>My Orders</h3>
      <div *ngIf="myOrders.length === 0">No orders found.</div>
      <table *ngIf="myOrders.length > 0" class="data-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Total Amount</th>
            <th>Status</th>
            <th>Payment</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let order of myOrders">
            <td>{{ order.order_id }}</td>
            <td>{{ order.order_date | date:'short' }}</td>
            <td>{{ order.total_amount | currency:'INR' }}</td>
            <td><span [class]="'status ' + order.status">{{ order.status }}</span></td>
            <td><span [class]="'status ' + order.payment_status">{{ order.payment_status }}</span></td>
          </tr>
        </tbody>
      </table>
    </div>


    <!-- Payment Confirmation Modal -->
    <div *ngIf="showPaymentModal" class="modal-overlay">
      <div class="modal-content">
        <h3>Order Placed Successfully! üéâ</h3>
        <p>Order ID: {{ lastOrderId }}</p>

        <div class="payment-details">
          <p><strong>Please complete your payment to below Upi ID and send a snap to below whatsapp number or Mail
              ID</strong></p>
          <p>UPI ID: <strong>sample@ybl</strong></p>
          <p>Phone: <strong>+91 xxxxxxxxxx</strong></p>
          <p>Email: <strong>sample@ecom.com</strong></p>
        </div>

        <p><em>Upon verification, your payment status will be updated.</em></p>

        <button class="payment-btn" (click)="closePaymentModal()">Payment Completed</button>
      </div>
    </div>

  </div>
</div>